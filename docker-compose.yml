services:
  worker:
    build: .
    image: jinn-node:latest
    container_name: jinn-worker
    restart: unless-stopped

    env_file:
      - .env

    environment:
      - GEMINI_SANDBOX=false
      - OPERATE_PROFILE_DIR=/home/jinn/.operate
      - JINN_WORKSPACE_DIR=/app/jinn-repos

    volumes:
      # Persistent home dir: .operate/ (encrypted keystore) + .gemini/ (OAuth creds, extensions)
      - node-data:/home/jinn
      # Cached venture repo clones (ephemeral, saves re-clone time)
      - jinn-repos:/app/jinn-repos

    # Chrome requires more than the default 64MB shared memory
    shm_size: "2gb"

    ports:
      - "8080:8080"

    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:8080/health').then(r=>{if(r.ok)process.exit(0);else process.exit(1)}).catch(()=>process.exit(1))"]
      interval: 30s
      timeout: 5s
      start_period: 60s
      retries: 3

    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 2G

    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

volumes:
  node-data:
  jinn-repos:
